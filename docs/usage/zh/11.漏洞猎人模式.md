# Snow CLI 使用文档——漏洞猎人模式

欢迎使用 Snow CLI！这是一个功能强大的 AI 驱动命令行工具。

## 什么是漏洞猎人模式

漏洞猎人模式（Vulnerability Hunting Mode）是 Snow CLI 的一个专业安全分析代理模式，专注于发现和验证代码库中的安全漏洞。与普通对话模式不同，该模式会遵循严格的安全分析流程，提供系统化的漏洞检测、证据收集、验证脚本生成和详细报告。

## 为什么使用漏洞猎人模式

在软件开发过程中，安全漏洞可能导致严重后果。漏洞猎人模式提供了专业的安全分析能力：

- 系统化的漏洞检测流程，涵盖多种漏洞类型
- 基于证据的分析，避免误报
- 为每个漏洞生成可执行的验证脚本
- 详细的修复建议和优先级排序
- 交互式沟通，确保分析范围准确
- 专注于特定模块，避免泛泛而谈

## 启用漏洞猎人模式

### 使用指令切换

在 Snow CLI 对话界面输入：

```
/vulnerability-hunting
```

系统会显示模式切换提示，再次输入该指令可以关闭该模式。

### 模式状态

- 模式状态会保存在 localStorage 中
- 重启应用后保持上次的状态
- 可以随时切换回普通模式

## 核心原则

漏洞猎人模式遵循以下核心原则：

### 1. 用户查询优先

AI 会优先响应您的实际问题和需求，不会在您没有要求时擅自分析整个代码库。

### 2. 语言适应

AI 始终使用与您相同的语言进行回复和生成报告。

### 3. 交互式沟通

AI 会频繁使用交互式问答来：
- 澄清模糊的需求
- 确认分析范围
- 询问具体测试场景
- 验证发现的问题
- 获取修改代码的权限

### 4. 基于证据的分析

所有漏洞报告必须有具体的代码证据，AI 不会进行猜测或假设。

### 5. 聚焦范围

每次只分析特定的模块或组件，不会一次性分析整个代码库。

### 6. 验证要求

每个漏洞都必须有验证脚本或概念验证代码。

### 7. 只读分析

除非您明确要求，否则 AI 不会修改源代码，只会生成报告和建议。

## 完整工作流程

漏洞猎人模式遵循严格的5阶段工作流程：

### 阶段 1：范围定义（强制性）

**目标**：明确定义要分析的具体区域。

**流程**：

1. **如果您没有指定模块**：
   - AI 会探索代码库结构
   - 列出主要模块和组件
   - 询问您想分析哪个具体区域

2. **如果您指定了模糊区域**：
   - AI 会将其细分为更小的子组件
   - 询问您是否关注所有部分还是特定部分

3. **开始分析前确认**：
   - 优先检查哪类漏洞（逻辑错误 vs 安全问题）
   - 预期的分析深度
   - 是否有特定关注点或已知问题

**范围文档示例**：

```markdown
# 漏洞分析范围：认证模块

## 目标区域
- 模块/组件：用户认证系统
- 待分析文件：
  - src/auth/login.ts
  - src/auth/session.ts
  - src/auth/jwt.ts
- 关键功能：
  - 用户登录
  - 会话管理
  - Token 验证
- 已知攻击面：
  - 登录表单输入
  - JWT token 处理
  - 会话过期检查

## 分析重点
- [x] 输入验证
- [x] 认证/授权
- [x] 数据清理
- [ ] 错误处理
- [ ] 资源管理

## 范围外
- 不分析前端 UI 组件
- 不分析数据库查询（将在后续会话中分析）
```

### 阶段 2：漏洞分析

**目标**：系统性分析范围内的安全问题。

**检查类别**（按优先级排序）：

#### 1. 逻辑和代码质量问题（最高优先级）

这是内部代码错误，通常比外部攻击向量更常见：

- 空指针/未定义访问
- 数组越界和边界条件错误
- 无限循环和递归问题
- 竞态条件和并发错误
- 内存泄漏和资源耗尽
- 错误的计算和算法
- 状态损坏和数据不一致
- 死锁和阻塞操作
- 类型混淆和转换错误
- 缓冲区溢出和下溢

#### 2. 业务逻辑缺陷

- 工作流绕过和状态操纵
- 授权逻辑错误
- 价格计算错误
- 数据验证绕过
- 时间检查与使用时间（TOCTOU）问题
- 业务逻辑中的整数溢出/下溢

#### 3. 输入验证和注入攻击

- SQL/NoSQL 注入
- 命令注入
- 路径遍历
- XSS（跨站脚本）
- LDAP 注入
- XML 注入

#### 4. 认证和授权

- 弱凭证
- 会话管理问题
- 权限提升
- 缺少认证检查
- 不安全的 token 处理

#### 5. 数据暴露

- 日志中的敏感数据
- 未加密存储
- 错误信息泄露
- 不安全的数据传输

#### 6. 配置和依赖

- 不安全的默认配置
- 已知的易受攻击依赖项
- 暴露的调试功能
- 错误配置的权限

#### 7. 错误处理和日志

- 错误中的信息泄露
- 日志记录不足
- 不安全的错误处理

### 阶段 3：证据收集

**目标**：为每个潜在漏洞收集具体证据。

**每个发现需要包含**：

1. **精确位置**：文件路径、行号、函数名
2. **漏洞类型**：类别和严重程度
3. **代码证据**：实际有问题的代码片段
4. **攻击向量**：如何利用这个漏洞
5. **影响评估**：可能造成的损害
6. **复现步骤**：如何触发该漏洞

**漏洞报告格式**：

```markdown
# 漏洞报告：JWT Token 签名验证缺失

## 严重程度：Critical（严重）

## 位置
- 文件：`src/auth/jwt.ts`
- 行号：45-52
- 函数/方法：`verifyToken`

## 漏洞类型
认证绕过 - 缺少签名验证

## 描述
JWT token 验证函数只检查 token 的格式和过期时间，但没有验证签名。
攻击者可以伪造任意 token 获取未授权访问。

## 证据
```typescript
function verifyToken(token: string): TokenPayload | null {
  try {
    // 只解码 token，没有验证签名
    const decoded = jwt.decode(token);
    
    if (!decoded || decoded.exp < Date.now() / 1000) {
      return null;
    }
    
    return decoded as TokenPayload;
  } catch (error) {
    return null;
  }
}
```

## 攻击场景
1. 攻击者获取一个有效的 JWT token
2. 修改 payload 中的用户 ID 和权限
3. 使用伪造的 token 访问 API
4. 系统接受该 token，因为只检查了格式和过期时间
5. 攻击者获得管理员权限

## 潜在影响
- 完全的认证绕过
- 未授权访问所有用户数据
- 权限提升到管理员
- 数据泄露和篡改

## 受影响组件
- 所有需要认证的 API 端点
- 用户资料管理
- 管理员后台
- 支付系统

## 验证脚本
位置：`.snow/vulnerability-hunting/scripts/verify-jwt-bypass.js`
查看下方验证部分了解使用方法。
```

### 阶段 4：验证脚本创建

**目标**：创建可执行的概念验证脚本，真实触发和验证漏洞。

**关键要求**：

1. **必须执行真实测试**：脚本必须尝试触发实际漏洞
2. **必须显示证据**：打印漏洞触发的精确位置（文件:行:函数）
3. **必须显示输出**：展示具体证据（堆栈跟踪、错误消息、利用结果）
4. **必须可执行**：不是文档，而是真正可运行的代码
5. **安全运行**：应展示问题但不造成永久损害

**逻辑错误验证脚本示例**：

```javascript
// verify-null-pointer.js
// 验证未定义访问错误

const userService = require('./src/services/userService');

console.log('========================================');
console.log('漏洞验证：空指针访问');
console.log('========================================\n');

const testCases = [
  null,
  {},
  { user: undefined },
  { user: { name: null } }
];

console.log('[1/3] 准备测试用例...');
console.log(`测试用例数：${testCases.length}\n`);

console.log('[2/3] 触发漏洞...');
for (let i = 0; i < testCases.length; i++) {
  try {
    console.log(`测试用例 ${i + 1}:`, JSON.stringify(testCases[i]));
    userService.processUserData(testCases[i]);
    console.log('  结果: 通过\n');
  } catch (error) {
    console.error('  ✓ 漏洞已触发!');
    console.error(`  位置: ${error.stack.split('\n')[1].trim()}`);
    console.error(`  错误: ${error.message}\n`);
    
    console.log('[3/3] 验证结果:');
    console.log('---');
    console.log('状态: 漏洞已确认');
    console.log('文件: src/services/userService.ts');
    console.log('函数: processUserData()');
    console.log('问题: 未检查输入是否为 null/undefined');
    console.log('---\n');
    process.exit(1);
  }
}

console.log('[3/3] 验证结果: 未发现漏洞');
process.exit(0);
```

**安全漏洞验证脚本示例**：

```bash
#!/bin/bash
# verify-sql-injection.sh
# 验证 SQL 注入漏洞

set -e

echo "========================================="
echo "漏洞验证：SQL 注入"
echo "========================================="
echo ""

echo "[1/3] 设置测试环境..."
# 启动测试数据库
docker-compose up -d test-db
sleep 2

echo "[2/3] 触发漏洞..."
# 发送恶意 SQL payload
RESPONSE=$(curl -s -X POST http://localhost:3000/api/users/search \
  -H "Content-Type: application/json" \
  -d '{"username": "admin'\'' OR '\''1'\''='\''1"}')

echo "[3/3] 验证结果:"
echo "---"

if echo "$RESPONSE" | grep -q "admin"; then
  echo "状态: 漏洞已确认"
  echo "位置: src/controllers/userController.ts:searchUser()"
  echo "payload: admin' OR '1'='1"
  echo "结果: 成功绕过认证，获取所有用户数据"
  echo "---"
  echo ""
  echo "返回数据示例:"
  echo "$RESPONSE" | head -n 10
  
  # 清理
  docker-compose down
  exit 1
else
  echo "状态: 漏洞未触发"
  echo "---"
  docker-compose down
  exit 0
fi
```

**脚本存储位置**：`.snow/vulnerability-hunting/scripts/`

### 阶段 5：报告和建议

**目标**：记录发现并提供清晰的修复指导。

**完整报告结构**：

```markdown
# 漏洞分析报告：认证模块

**日期**：2025-12-15
**分析组件**：用户认证系统（login.ts, session.ts, jwt.ts）
**分析耗时**：2小时

## 执行摘要

对认证模块进行了全面的安全分析，发现3个严重漏洞、2个高危漏洞和5个中危漏洞。
最关键的问题是 JWT token 签名验证缺失，可能导致完全的认证绕过。建议立即修复严重
和高危漏洞。

## 发现汇总

- 严重：3 个
- 高危：2 个
- 中危：5 个
- 低危：1 个
- 总计：11 个

## 详细发现

### [1] JWT Token 签名验证缺失 - 严重

**位置**：
- 文件：`src/auth/jwt.ts`
- 行号：45-52
- 函数：`verifyToken()`

**漏洞类型**：认证绕过

**描述**：
JWT token 验证函数只检查格式和过期时间，但没有验证签名。攻击者可以伪造任意
token 获取未授权访问。

**证据**：
```typescript
function verifyToken(token: string): TokenPayload | null {
  // 只解码，没有验证签名
  const decoded = jwt.decode(token);
  if (!decoded || decoded.exp < Date.now() / 1000) {
    return null;
  }
  return decoded as TokenPayload;
}
```

**验证**：
位置：`.snow/vulnerability-hunting/scripts/verify-jwt-bypass.js`

使用方法：
```bash
cd .snow/vulnerability-hunting/scripts
node verify-jwt-bypass.js
```

预期输出（如果存在漏洞）：
```
✓ 漏洞已触发!
位置: src/auth/jwt.ts:verifyToken():48
伪造的 token 被接受
用户 ID 从 123 修改为 1（管理员）
```

**建议修复**：
```typescript
function verifyToken(token: string): TokenPayload | null {
  try {
    // 使用 verify 而不是 decode，包含签名验证
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    
    if (!decoded || decoded.exp < Date.now() / 1000) {
      return null;
    }
    
    return decoded as TokenPayload;
  } catch (error) {
    // 签名验证失败
    console.error('Token 验证失败:', error.message);
    return null;
  }
}
```

**优先级**：立即修复
- 允许完全绕过认证
- 影响所有认证功能
- 可能导致数据泄露和篡改

---

### [2] 会话固定攻击 - 高危

[继续其他漏洞的详细信息...]

---

## 整体风险评估

当前认证系统存在严重的安全风险，主要体现在：

1. **认证机制薄弱**：JWT 签名验证缺失是最严重问题
2. **会话管理不当**：存在会话固定和并发会话问题
3. **输入验证不足**：多处缺少输入清理和验证
4. **错误处理泄露**：错误消息暴露敏感信息

**风险等级**：严重

## 修复优先级

1. **立即修复（24小时内）**：
   - [严重] JWT Token 签名验证缺失
   - [严重] SQL 注入漏洞（登录表单）
   - [严重] 明文密码存储

2. **高优先级（1周内）**：
   - [高危] 会话固定攻击
   - [高危] 权限提升漏洞

3. **中优先级（2周内）**：
   - [中危] 会话超时配置不当
   - [中危] 缺少登录尝试限制
   - [中危] Token 刷新机制缺失
   - [中危] CORS 配置过于宽松
   - [中危] 密码复杂度要求不足

4. **低优先级（1个月内）**：
   - [低危] 日志记录不足

## 预防建议

为防止类似问题再次出现，建议：

1. **安全开发培训**：
   - 定期进行安全编码培训
   - 建立安全代码审查流程
   - 使用安全检查清单

2. **自动化安全测试**：
   - 集成 SAST（静态应用安全测试）工具
   - 添加安全单元测试
   - 实施 CI/CD 安全检查

3. **认证最佳实践**：
   - 使用成熟的认证库（如 Passport.js）
   - 实施多因素认证（MFA）
   - 定期更新依赖项

4. **监控和审计**：
   - 实施实时安全监控
   - 记录所有认证事件
   - 定期进行安全审计

5. **加密和数据保护**：
   - 使用强加密算法
   - 实施数据脱敏
   - 定期备份和加密敏感数据
```

## 使用场景示例

### 场景 1：分析特定模块

```
您：进入漏洞猎人模式，分析认证模块

AI：好的，我已切换到漏洞猎人模式。让我先探索认证模块的结构...

我发现了以下认证相关组件：
1. 登录流程（login.ts, auth.ts）
2. 会话管理（session.ts, middleware.ts）
3. 密码重置（resetPassword.ts）
4. Token 处理（jwt.ts, tokenService.ts）

您想先分析哪个具体区域？还是我应该检查所有组件？

您：先检查 JWT token 处理

AI：明白了。在开始分析前，我想确认一下：

您希望我优先关注：
1. 逻辑错误（空值检查、边界情况、竞态条件）
2. 安全问题（注入、认证绕过、数据泄露）
3. 两者都检查

您：两者都检查

AI：好的，我将全面分析 JWT token 处理模块...

[执行分析...]

我发现了以下问题：
1. [严重] JWT 签名验证缺失
2. [高危] Token 过期检查逻辑错误
3. [中危] 缺少 Token 刷新机制

我已经创建了验证脚本。您想查看详细报告吗？
```

### 场景 2：验证已知问题

```
您：我怀疑用户输入处理有 SQL 注入问题，帮我验证一下

AI：好的，让我定位用户输入处理的相关代码...

我找到了这些处理用户输入的地方：
- src/controllers/userController.ts:searchUser()
- src/controllers/productController.ts:search()
- src/services/queryBuilder.ts:buildQuery()

这些都是您关注的吗？还是有特定的函数？

您：主要是 searchUser 函数

AI：明白了。我将重点分析该函数的 SQL 注入风险...

[分析后...]

确认发现 SQL 注入漏洞！详情：
- 位置：src/controllers/userController.ts:42
- 问题：直接拼接用户输入到 SQL 查询
- 严重程度：严重

我已创建验证脚本：.snow/vulnerability-hunting/scripts/verify-sql-injection.sh

运行该脚本可以实际触发漏洞。需要我生成详细报告和修复建议吗？
```

### 场景 3：生成安全报告

```
您：为整个 API 模块生成安全分析报告

AI：好的，API 模块很大。让我先列出主要的子模块：

1. 用户 API（/api/users/*）
2. 产品 API（/api/products/*）
3. 订单 API（/api/orders/*）
4. 认证 API（/api/auth/*）
5. 管理 API（/api/admin/*）

由于模块较多，建议分批分析。您想从哪个开始？
还是我应该做一个快速的高层次扫描，找出最明显的问题？

您：先做快速扫描，找出严重问题

AI：明白了，我将进行快速安全扫描，重点关注严重漏洞...

[扫描后...]

快速扫描完成，发现以下严重问题：

1. [严重] 用户 API：SQL 注入（3处）
2. [严重] 认证 API：JWT 签名验证缺失
3. [严重] 管理 API：缺少权限检查
4. [高危] 订单 API：竞态条件可能导致重复扣款

建议先修复这些严重问题。需要我对每个问题创建详细报告和验证脚本吗？
```

## 文件结构

漏洞猎人模式生成的所有文件都存储在项目的 `.snow/vulnerability-hunting/` 目录下：

```
.snow/
└── vulnerability-hunting/
    ├── docs/                           # 分析报告目录
    │   ├── auth-module.md             # 认证模块报告
    │   ├── api-security-scan.md       # API 安全扫描报告
    │   └── payment-module.md          # 支付模块报告
    └── scripts/                        # 验证脚本目录
        ├── verify-jwt-bypass.js       # JWT 绕过验证
        ├── verify-sql-injection.sh    # SQL 注入验证
        ├── verify-race-condition.js   # 竞态条件验证
        └── verify-auth-bypass.py      # 认证绕过验证
```

### 报告命名规范

- 使用小写字母和连字符
- 格式：`[模块名]-[报告类型].md`
- 示例：`auth-module.md`、`api-security-scan.md`

### 脚本命名规范

- 使用小写字母和连字符
- 格式：`verify-[漏洞类型].[扩展名]`
- 示例：`verify-sql-injection.sh`、`verify-null-pointer.js`

## 最佳实践

### 1. 明确分析范围

不要要求分析整个代码库，而是：
- 指定具体的模块或组件
- 明确关注的漏洞类型
- 提供已知的风险点

### 2. 及时沟通

AI 会频繁询问以确认细节，请：
- 回答 AI 的问题以明确需求
- 提供额外的上下文信息
- 说明特定的安全关注点

### 3. 验证发现

对于 AI 发现的问题：
- 运行提供的验证脚本
- 在测试环境中确认
- 评估实际影响

### 4. 优先级修复

根据报告中的优先级：
- 立即修复严重漏洞
- 按优先级排序其他问题
- 记录修复过程

### 5. 持续改进

漏洞修复后：
- 要求 AI 重新验证
- 添加安全测试
- 更新安全检查清单

## 限制和注意事项

### 1. 分析范围

- 每次只分析特定模块，不是整个代码库
- 需要明确指定分析范围
- 大型项目建议分多次分析

### 2. 验证脚本

- 脚本应在隔离环境中运行
- 某些脚本可能需要特定的测试环境
- 运行前请仔细阅读脚本内容

### 3. 只读模式

- 默认情况下不修改源代码
- 只生成报告和修复建议
- 需要代码修复时必须明确要求

### 4. 误报可能性

- AI 分析可能产生误报
- 始终验证发现的问题
- 结合人工审查

### 5. 覆盖范围

- 不能保证发现所有漏洞
- 专注于常见和严重的安全问题
- 建议结合其他安全工具

## 常见问题

**Q: 漏洞猎人模式和普通模式有什么区别？**

A: 漏洞猎人模式是专门的安全分析代理，遵循严格的5阶段工作流程，生成详细报告和验证脚本。普通模式更通用，适合日常开发任务。

**Q: 分析一个模块需要多长时间？**

A: 取决于模块大小和复杂度。小型模块（几百行）可能需要几分钟，中型模块（几千行）可能需要10-30分钟，大型模块建议拆分分析。

**Q: 验证脚本安全吗？**

A: 验证脚本设计为安全运行，不会造成永久性损害。但建议在隔离的测试环境中运行，不要在生产环境执行。

**Q: AI 可以自动修复漏洞吗？**

A: 默认情况下不会。AI 只提供修复建议。如果需要自动修复，必须明确要求，AI 会先征求您的确认。

**Q: 如何查看之前的分析报告？**

A: 所有报告保存在 `.snow/vulnerability-hunting/docs/` 目录下，可以随时查看。

**Q: 可以自定义分析类别吗？**

A: 可以。AI 会在开始前询问您关注哪些类别。您可以指定只检查逻辑错误、只检查安全问题，或两者都检查。

**Q: 漏洞猎人模式支持哪些编程语言？**

A: 支持常见的编程语言，包括 JavaScript/TypeScript、Python、Java、Go、Rust、C# 等。分析质量取决于代码库的索引状态。

**Q: 发现的漏洞会自动报告给团队吗？**

A: 不会。所有报告只存储在本地。您需要手动分享报告或集成到您的安全工作流中。

**Q: 可以导出报告到其他格式吗？**

A: 报告以 Markdown 格式生成，可以轻松转换为 PDF、HTML 或其他格式。您也可以要求 AI 生成特定格式的报告。

**Q: 如何结合 CI/CD 使用？**

A: 可以在 CI/CD 流程中运行验证脚本，检测已知漏洞是否修复。但完整的分析建议手动触发，因为需要交互式沟通。

## 相关功能

- [指令面板说明](./9.指令面板说明.md) - 了解 `/vulnerability-hunting` 等指令
- [敏感命令配置](./6.敏感命令配置.md) - 配置需要确认的危险命令
- [代码库设置](./4.代码库设置.md) - 启用代码库索引以提升分析效果
